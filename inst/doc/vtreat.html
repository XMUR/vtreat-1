<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="John Mount, Nina Zumel" />

<meta name="date" content="2015-11-10" />

<title>vtreat package</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%7D%0Apre%20%7B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">vtreat package</h1>
<h4 class="author"><em>John Mount, Nina Zumel</em></h4>
<h4 class="date"><em>2015-11-10</em></h4>
</div>


<p>‘vtreat’ is a package that prepares arbitrary data frames into clean data frames that are ready for analysis. A clean data frame:</p>
<ul>
<li>Only has numeric columns (other than the outcome).</li>
<li>Has no Infinite/NA/NaN in the effective variable columns.</li>
</ul>
<p>To achieve this a number of techniques are used. Principally:</p>
<ul>
<li><a href="http://www.win-vector.com/blog/2012/07/modeling-trick-impact-coding-of-categorical-variables-with-many-levels/">Impact coding</a></li>
<li><a href="http://www.win-vector.com/blog/2014/12/a-comment-on-preparing-data-for-classifiers/">Encoding category levels as indicators</a></li>
</ul>
<p>For more details see: <a href="http://www.win-vector.com/blog/2014/08/vtreat-designing-a-package-for-variable-treatment/">the ‘vtreat’ article</a> and <a href="http://www.win-vector.com/blog/2015/05/what-is-new-in-the-vtreat-library/">update</a>.</p>
<p>The main pattern is the use of ‘designTreatmentsC()’ or ‘designTreatmentsN()’ to design a treatment plan and then use the returned structure with ‘prepare()’ to apply the plan to data frames. The main feature of ‘vtreat’ is all data preparation is “y-aware” or uses the relations of effective variables to the dependent or outcome variable to encode the effective variables.</p>
<p>The structure returned from ‘designTreatmentsN()’ or ‘designTreatmentsC()’ includes informational fields. The main fields are mostly vectors with names (all with the same names in the same order):</p>
<ul>
<li>‘vars’ : (character array without names) names of variables (in same order as names on the other diagnostic vectors)</li>
<li>‘varMoves’ : logical TRUE if the variable varied during training, only variables that move will be in the treated frame.</li>
<li>‘sig’ : significance of observed variable predictive value under an in-sample permutation test.</li>
</ul>
<p>In addition to these vectors ‘designTreatmentsC()’ and ‘designTreatmentsN()’ return a data frame named ‘scoreFrame’ which contains columns: - ‘varName’: name of new variable - ‘origName’: name of original variable variable was derived from (can repeat) - ‘varMoves’ : logical TRUE if the variable varied during training, only variables that move will be in the treated frame. - ‘PRESSRsquared’ : a PRESS-held out R-squared of a linear fit from each variable to the y-value. Scores of zero and below are very bad, scores near one are very good. - ‘psig’ : significance of observed variable ‘PRESSRsquared’ value under an in-sample permutation test. - ‘catPRSquared’ : for categorical outcomes: deviance based pseudo-Rsquared. - ‘csig’ : for categorical outcomes: significance of observed variable catPRSquared value under an in-sample permutation test. - ‘sig’ : ‘csig’ for categorical outcomes, ‘psig’ otherwise.</p>
<p>In all cases we have two undesirable upward biases on the scores:</p>
<ul>
<li>The treated variables view the training data during construction (for setting of NA values, missing values, levels, and more). So this gives an upward bias when trying to measure treated variable utility on training data. Until the data set is at least 1000 good rows we ignore this effect. After 1000 rows we design variables on a pseudo-random chosen 80% of the rows and score on the complimentary 20% of the rows.</li>
<li>The scoring procedure itself involves a fit (linear regression for ‘PRESSRsquared’ or logistic regression for ‘catPseudoRSquared’). So in each of these cases we would like the regression itself to be only evaluated on held-out data. The PRESS statistic does just that (fast 1-way cross validation). The ‘catPseudoRSquared’ performs explicit 1-way cross validation for small data sets and hold-out scoring for larger data sets.</li>
</ul>
<p>‘vtreat’ uses a number of cross-training and jackknife style procedures to try to mitigate these effects. The suggested best practice is (if you have enough data) to split your randomly into at least the following disjoint data sets:</p>
<ul>
<li>Encoding Calibration : a data set used for the ‘designTreatmentsC()’ or ‘designTreatmentsN()’ step and not used again for training or test.</li>
<li>Training : a data set used (after ‘prepare()’) for training your model.</li>
<li>Test : a data set used (after ‘prepare()’) for estimating your model’s out of training performance.</li>
</ul>
<p>The idea is: taking the extra step to perform the ‘designTreatmentsC()’ or ‘designTreatmentsN()’ on data disjoint from training makes the training data more exchangeable with test and avoids the issue that ‘vtreat’ may be hiding a large number of degrees of freedom in variables it derives from large categoricals.</p>
<p>An trivial execution example (not demonstrating any cal/train/test split) is given below. Variables that do not move during hold-out testing are considered “not to move.”</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(vtreat)
dTrainC &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="ot">NA</span>),
   <span class="dt">z=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="ot">NA</span>,<span class="dv">6</span>),<span class="dt">y=</span><span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>,<span class="ot">TRUE</span>))
<span class="kw">head</span>(dTrainC)</code></pre>
<pre><code>##      x  z     y
## 1    a  1 FALSE
## 2    a  2 FALSE
## 3    a  3  TRUE
## 4    b  4 FALSE
## 5    b NA  TRUE
## 6 &lt;NA&gt;  6  TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dTestC &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="ot">NA</span>))
<span class="kw">head</span>(dTestC)</code></pre>
<pre><code>##      x  z
## 1    a 10
## 2    b 20
## 3    c 30
## 4 &lt;NA&gt; NA</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">treatmentsC &lt;-<span class="st"> </span><span class="kw">designTreatmentsC</span>(dTrainC,<span class="kw">colnames</span>(dTrainC),<span class="st">'y'</span>,<span class="ot">TRUE</span>)</code></pre>
<pre><code>## [1] &quot;desigining treatments Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;design var x Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;design var z Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;scoring treatments Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;WARNING skipped vars: x&quot;
## [1] &quot;have treatment plan Tue Nov 10 12:28:24 2015&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(treatmentsC)</code></pre>
<pre><code>## $treatments
## $treatments[[1]]
## [1] &quot;vtreat 'Categoric Indicators'('x'-&gt;character-&gt;'x_lev_rare')&quot;
## 
## $treatments[[2]]
## [1] &quot;vtreat 'Bayesian Impact Code'('x'-&gt;character-&gt;'x_catB')&quot;
## 
## $treatments[[3]]
## [1] &quot;vtreat 'Scalable pass through'('z'-&gt;numeric-&gt;'z_clean')&quot;
## 
## $treatments[[4]]
## [1] &quot;vtreat 'is.bad'('z'-&gt;numeric-&gt;'z_isBAD')&quot;
## 
## 
## $vars
## [1] &quot;z_clean&quot; &quot;z_isBAD&quot;
## 
## $varMoves
## z_clean z_isBAD 
##    TRUE    TRUE 
## 
## $sig
##   z_clean   z_isBAD 
## 0.2601608 1.0000000 
## 
## $scoreFrame
##   varName origName varMoves PRESSRsquared psig       sig catPRSquared
## 1 z_clean        z     TRUE    -0.8237958    1 0.2601608    0.1524329
## 2 z_isBAD        z     TRUE     0.0000000    1 1.0000000    0.0000000
##        csig
## 1 0.2601608
## 2 1.0000000
## 
## $nmMap
## $nmMap[[1]]
## $nmMap[[1]]$new
## [1] &quot;x_lev_rare&quot;
## 
## $nmMap[[1]]$orig
## [1] &quot;x&quot;
## 
## 
## $nmMap[[2]]
## $nmMap[[2]]$new
## [1] &quot;x_catB&quot;
## 
## $nmMap[[2]]$orig
## [1] &quot;x&quot;
## 
## 
## $nmMap[[3]]
## $nmMap[[3]]$new
## [1] &quot;z_clean&quot;
## 
## $nmMap[[3]]$orig
## [1] &quot;z&quot;
## 
## 
## $nmMap[[4]]
## $nmMap[[4]]$new
## [1] &quot;z_isBAD&quot;
## 
## $nmMap[[4]]$orig
## [1] &quot;z&quot;
## 
## 
## 
## $outcomename
## [1] &quot;y&quot;
## 
## $meanY
## [1] 0.5
## 
## $ndat
## [1] 6
## 
## $skippedVars
## [1] &quot;x&quot;
## 
## attr(,&quot;class&quot;)
## [1] &quot;treatmentplan&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(treatmentsC$treatments[[<span class="dv">1</span>]])</code></pre>
<pre><code>## [1] &quot;vtreat 'Categoric Indicators'('x'-&gt;character-&gt;'x_lev_rare')&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dTrainCTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsC,dTrainC,<span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)
<span class="kw">head</span>(dTrainCTreated)</code></pre>
<pre><code>##         z_clean z_isBAD     y
## 1 -3.864865e-01    -0.1 FALSE
## 2 -2.108108e-01    -0.1 FALSE
## 3 -3.513514e-02    -0.1  TRUE
## 4  1.405405e-01    -0.1 FALSE
## 5 -2.220446e-16     0.5  TRUE
## 6  4.918919e-01    -0.1  TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">varsC &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">colnames</span>(dTrainCTreated),<span class="st">'y'</span>)
<span class="co"># all input variables should be mean 0</span>
<span class="kw">sapply</span>(dTrainCTreated[,varsC,<span class="dt">drop=</span><span class="ot">FALSE</span>],mean)</code></pre>
<pre><code>##       z_clean       z_isBAD 
## -1.942890e-16 -2.543922e-17</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># all slopes should be 1</span>
<span class="kw">sapply</span>(varsC,function(c) { <span class="kw">lm</span>(<span class="kw">paste</span>(<span class="st">'y'</span>,c,<span class="dt">sep=</span><span class="st">'~'</span>),
   <span class="dt">data=</span>dTrainCTreated)$coefficients[[<span class="dv">2</span>]]})</code></pre>
<pre><code>## z_clean z_isBAD 
##       1       1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dTestCTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsC,dTestC,<span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)
<span class="kw">head</span>(dTestCTreated)</code></pre>
<pre><code>##         z_clean z_isBAD
## 1  4.918919e-01    -0.1
## 2  4.918919e-01    -0.1
## 3  4.918919e-01    -0.1
## 4 -2.220446e-16     0.5</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># numeric example</span>
dTrainN &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="ot">NA</span>),
   <span class="dt">z=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="ot">NA</span>,<span class="dv">7</span>),<span class="dt">y=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">head</span>(dTrainN)</code></pre>
<pre><code>##   x  z y
## 1 a  1 0
## 2 a  2 0
## 3 a  3 0
## 4 a  4 1
## 5 b  5 0
## 6 b NA 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dTestN &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="ot">NA</span>))
<span class="kw">head</span>(dTestN)</code></pre>
<pre><code>##      x  z
## 1    a 10
## 2    b 20
## 3    c 30
## 4 &lt;NA&gt; NA</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">treatmentsN =<span class="st"> </span><span class="kw">designTreatmentsN</span>(dTrainN,<span class="kw">colnames</span>(dTrainN),<span class="st">'y'</span>)</code></pre>
<pre><code>## [1] &quot;desigining treatments Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;design var x Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;design var z Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;scoring treatments Tue Nov 10 12:28:24 2015&quot;
## [1] &quot;WARNING skipped vars: x&quot;
## [1] &quot;have treatment plan Tue Nov 10 12:28:24 2015&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(treatmentsN)</code></pre>
<pre><code>## $treatments
## $treatments[[1]]
## [1] &quot;vtreat 'Categoric Indicators'('x'-&gt;character-&gt;'x_lev_rare')&quot;
## 
## $treatments[[2]]
## [1] &quot;vtreat 'Scalable Impact Code'('x'-&gt;character-&gt;'x_catN')&quot;
## 
## $treatments[[3]]
## [1] &quot;vtreat 'Scalable pass through'('z'-&gt;numeric-&gt;'z_clean')&quot;
## 
## $treatments[[4]]
## [1] &quot;vtreat 'is.bad'('z'-&gt;numeric-&gt;'z_isBAD')&quot;
## 
## 
## $vars
## [1] &quot;z_clean&quot; &quot;z_isBAD&quot;
## 
## $varMoves
## z_clean z_isBAD 
##    TRUE    TRUE 
## 
## $sig
## z_clean z_isBAD 
##       1       1 
## 
## $scoreFrame
##   varName origName varMoves PRESSRsquared psig sig
## 1 z_clean        z     TRUE    -0.4545128    1   1
## 2 z_isBAD        z     TRUE     0.0000000    1   1
## 
## $nmMap
## $nmMap[[1]]
## $nmMap[[1]]$new
## [1] &quot;x_lev_rare&quot;
## 
## $nmMap[[1]]$orig
## [1] &quot;x&quot;
## 
## 
## $nmMap[[2]]
## $nmMap[[2]]$new
## [1] &quot;x_catN&quot;
## 
## $nmMap[[2]]$orig
## [1] &quot;x&quot;
## 
## 
## $nmMap[[3]]
## $nmMap[[3]]$new
## [1] &quot;z_clean&quot;
## 
## $nmMap[[3]]$orig
## [1] &quot;z&quot;
## 
## 
## $nmMap[[4]]
## $nmMap[[4]]$new
## [1] &quot;z_isBAD&quot;
## 
## $nmMap[[4]]$orig
## [1] &quot;z&quot;
## 
## 
## 
## $outcomename
## [1] &quot;y&quot;
## 
## $meanY
## [1] 0.4285714
## 
## $ndat
## [1] 7
## 
## $skippedVars
## [1] &quot;x&quot;
## 
## attr(,&quot;class&quot;)
## [1] &quot;treatmentplan&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dTrainNTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsN,dTrainN,
                          <span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)
<span class="kw">head</span>(dTrainNTreated)</code></pre>
<pre><code>##       z_clean    z_isBAD y
## 1 -0.41904762 -0.0952381 0
## 2 -0.26190476 -0.0952381 0
## 3 -0.10476190 -0.0952381 0
## 4  0.05238095 -0.0952381 1
## 5  0.20952381 -0.0952381 0
## 6  0.00000000  0.5714286 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">varsN &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">colnames</span>(dTrainNTreated),<span class="st">'y'</span>)
<span class="co"># all input variables should be mean 0</span>
<span class="kw">sapply</span>(dTrainNTreated[,varsN,<span class="dt">drop=</span><span class="ot">FALSE</span>],mean) </code></pre>
<pre><code>##       z_clean       z_isBAD 
##  4.757324e-17 -7.929874e-17</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># all slopes should be 1</span>
<span class="kw">sapply</span>(varsN,function(c) { <span class="kw">lm</span>(<span class="kw">paste</span>(<span class="st">'y'</span>,c,<span class="dt">sep=</span><span class="st">'~'</span>),
   <span class="dt">data=</span>dTrainNTreated)$coefficients[[<span class="dv">2</span>]]}) </code></pre>
<pre><code>## z_clean z_isBAD 
##       1       1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># prepared frame</span>
dTestNTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsN,dTestN,
                         <span class="dt">pruneSig=</span><span class="kw">c</span>())
<span class="kw">head</span>(dTestNTreated)</code></pre>
<pre><code>##    z_clean z_isBAD
## 1 7.000000       0
## 2 7.000000       0
## 3 7.000000       0
## 4 3.666667       1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># scaled prepared frame</span>
dTestNTreatedS &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsN,dTestN,
                         <span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)
<span class="kw">head</span>(dTestNTreatedS)</code></pre>
<pre><code>##     z_clean    z_isBAD
## 1 0.5238095 -0.0952381
## 2 0.5238095 -0.0952381
## 3 0.5238095 -0.0952381
## 4 0.0000000  0.5714286</code></pre>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
